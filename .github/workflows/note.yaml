name: Note Workflow (Gemini Ver2.)

on:
  workflow_dispatch:
    inputs:
      theme:
        description: 'Ë®ò‰∫ã„ÉÜ„Éº„Éû'
        required: true
        type: string
      target:
        description: 'ÊÉ≥ÂÆöË™≠ËÄÖÔºà„Éö„É´„ÇΩ„ÉäÔºâ'
        required: true
        type: string
      message:
        description: 'Ë™≠ËÄÖ„Å´‰ºù„Åà„Åü„ÅÑÊ†∏„É°„ÉÉ„Çª„Éº„Ç∏'
        required: true
        type: string
      cta:
        description: 'Ë™≠Âæå„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥ÔºàCTAÔºâ'
        required: true
        type: string
      tags:
        description: '„Ç´„É≥„ÉûÂå∫Âàá„Çä„Çø„Ç∞Ôºà‰ªªÊÑèÔºâ'
        required: false
        default: ''
        type: string
      is_public:
        description: 'ÂÖ¨Èñã(true)/‰∏ãÊõ∏„Åç(false)'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      dry_run:
        description: 'ÊäïÁ®ø„Çí„Çπ„Ç≠„ÉÉ„ÉóÔºàÁîüÊàê„ÅÆ„ÅøÔºâ'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: read

env:
  TZ: Asia/Tokyo

jobs:
  research:
    name: Research (Gemini + Tavily)
    runs-on: ubuntu-latest
    env:
      GOOGLE_GENERATIVE_AI_API_KEY: ${{ secrets.GOOGLE_GENERATIVE_AI_API_KEY }}
      TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
      THEME: ${{ github.event.inputs.theme }}
      TARGET: ${{ github.event.inputs.target }}
    outputs:
      research_b64: ${{ steps.collect.outputs.research_b64 }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install AI SDK
        run: |
          npm init -y
          npm i ai @ai-sdk/google # ‚òÖ‚òÖ‚òÖ„Åì„Åì„Çí @ai-sdk/google „Å´‰øÆÊ≠£ÔºÅ‚òÖ‚òÖ‚òÖ

      - name: Research with Gemini + Tavily
        run: |
          cat > research.mjs <<'EOF'
          import { generateText } from 'ai';
          import { google } from '@ai-sdk/google'; // ‚òÖ‚òÖ‚òÖ„Åì„Åì„Çí @ai-sdk/google „Å´‰øÆÊ≠£ÔºÅ‚òÖ‚òÖ‚òÖ
          import fs from 'fs';
          const theme = process.env.THEME || '';
          const target = process.env.TARGET || '';
          const today = new Date().toISOString().slice(0,10);
          const artifactsDir = '.note-artifacts';
          fs.mkdirSync(artifactsDir, { recursive: true });
          const TAVILY_API_KEY = process.env.TAVILY_API_KEY || '';
          const modelName = 'gemini-2.0-flash-lite';
          
          if (!TAVILY_API_KEY) { console.error('TAVILY_API_KEY is not set'); process.exit(1); }

          async function tavilySearch(q) {
            const res = await fetch('https://api.tavily.com/search', {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ api_key: TAVILY_API_KEY, query: q, search_depth: 'advanced', max_results: 7, include_answer: true })
            });
            if (!res.ok) { return { query: q, results: [], answer: null }; }
            const json = await res.json().catch(() => ({}));
            return { query: q, results: Array.isArray(json.results) ? json.results : [], answer: json.answer || null };
          }
          
          function formatEvidence(items) {
            const lines = [];
            for (const it of items) {
              lines.push(`### Ê§úÁ¥¢„ÇØ„Ç®„É™: ${it.query}`);
              if (it.answer) { lines.push(`Tavily„ÅÆÂõûÁ≠î: ${it.answer}`); }
              for (const r of it.results || []) {
                const t = (r.title || '').toString();
                const u = (r.url || '').toString();
                const c = (r.content || '').toString().slice(0, 500);
                lines.push(`- [${t}](${u})\n  ${c}`);
              }
              lines.push('');
            }
            return lines.join('\n');
          }

          async function main() {
            const searchQuery = `„Äå${theme}„Äç„Å´„Å§„ÅÑ„Å¶„ÄÅ„Çø„Éº„Ç≤„ÉÉ„Éà„Äå${target}„ÄçÂêë„Åë„ÅÆÊúÄÊñ∞ÊÉÖÂ†±„ÄÇ‰∏ÄÊ¨°ÊÉÖÂ†±ÔºàÂÖ¨ÁöÑÊ©üÈñ¢„ÉªË¶èÊ†º„ÉªË´ñÊñá„ÉªÂÖ¨ÂºèÔºâ„ÇíÂÑ™ÂÖà„Åó„Å¶Ê§úÁ¥¢„ÄÇ`;
            const searchResult = await tavilySearch(searchQuery);
            const evidence = formatEvidence([searchResult]);
            
            const sys = [
              '„ÅÇ„Å™„Åü„ÅØÊúÄÊñ∞ÊÉÖÂ†±„ÅÆÂèéÈõÜ„Å®Ë¶ÅÁ¥Ñ„Å´ÁâπÂåñ„Åó„ÅüË∂Ö‰∏ÄÊµÅ„ÅÆ„É™„Çµ„Éº„ÉÅ„É£„Éº„Åß„Åô„ÄÇ',
              'Êèê‰æõ„Åï„Çå„ÅüÊ§úÁ¥¢ÁµêÊûúÔºà„Ç®„Éì„Éá„É≥„ÇπÔºâ„Å´Âü∫„Å•„Åç„ÄÅ‰∫ãÂÆü„Éô„Éº„Çπ„Åß„É¨„Éù„Éº„Éà„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
              'Êú¨ÊñáÂÜÖ„Å´Markdown„É™„É≥„ÇØ„ÅßÂá∫ÂÖ∏„ÇíÂøÖ„ÅöÂüã„ÇÅËæº„ÇÄ„Åì„Å®„ÄÇ',
              'ÂçÅÂàÜ„Å™ÂàÜÈáèÔºàÁõÆÂÆâ: 2,000Ë™û‰ª•‰∏äÔºâ„Åß„ÄÅÁ´†Á´ã„Å¶„Åó„Å¶Ë©≥Á¥∞„Å´Ë®òËø∞„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
            ].join('\n');
            const userPrompt = `‰ª•‰∏ã„ÅÆ„ÉÜ„Éº„Éû„ÄÅ„Çø„Éº„Ç≤„ÉÉ„Éà„ÄÅ„Ç®„Éì„Éá„É≥„Çπ„Å´Âü∫„Å•„Åç„ÄÅÊúÄÁµÇÁâà„ÅÆ„É™„Çµ„Éº„ÉÅ„É¨„Éù„Éº„Éà„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n„ÄêÈáçË¶Å„ÄëÈÄî‰∏≠ÁµåÈÅé„ÇÑÁ¢∫Ë™çË≥™Âïè„ÅØ‰∏ÄÂàá„Åõ„Åö„ÄÅÊúÄÁµÇ„É¨„Éù„Éº„Éà„ÅÆ„Åø„ÇíËøî„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n---\n„ÉÜ„Éº„Éû: ${theme}\n„Çø„Éº„Ç≤„ÉÉ„Éà: ${target}\nÁèæÂú®Êó•‰ªò: ${today}\n\n## „Ç®„Éì„Éá„É≥„ÇπÔºàTavilyÊ§úÁ¥¢ÁµêÊûúÔºâ\n${evidence}`;
            
            const { text } = await generateText({
              model: google(modelName), // ‚òÖ‚òÖ‚òÖ„Åì„Åì„Çí google() „Å´‰øÆÊ≠£ÔºÅ‚òÖ‚òÖ‚òÖ
              system: sys,
              prompt: userPrompt,
              temperature: 0.65,
              maxTokens: 12000,
            });
            
            const assistantTexts = text || '';
            fs.writeFileSync(`${artifactsDir}/research.md`, assistantTexts);
            try { fs.writeFileSync(`${artifactsDir}/research_trace.json`, JSON.stringify({ searchResult, report: assistantTexts }, null, 2)); } catch {}
          }
          
          await main();
          EOF
          node research.mjs

      - name: Collect research
        id: collect
        run: |
          b64=$(base64 -w 0 .note-artifacts/research.md 2>/dev/null || base64 .note-artifacts/research.md)
          echo "research_b64<<EOF" >> $GITHUB_OUTPUT
          echo "$b64" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload research artifacts
        uses: actions/upload-artifact@v4
        with:
          name: research-artifacts
          path: |
            .note-artifacts/research.md
            .note-artifacts/research_trace.json

  write:
    name: Write (Gemini)
    needs: research
    runs-on: ubuntu-latest
    env:
      GOOGLE_GENERATIVE_AI_API_KEY: ${{ secrets.GOOGLE_GENERATIVE_AI_API_KEY }}
      THEME: ${{ github.event.inputs.theme }}
      TARGET: ${{ github.event.inputs.target }}
      MESSAGE: ${{ github.event.inputs.message }}
      CTA: ${{ github.event.inputs.cta }}
      INPUT_TAGS: ${{ github.event.inputs.tags }}
    outputs:
      title: ${{ steps.collect.outputs.title }}
      draft_json_b64: ${{ steps.collect.outputs.draft_json_b64 }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install AI SDK
        run: |
          npm init -y
          npm i ai @ai-sdk/google # ‚òÖ‚òÖ‚òÖ„Åì„Åì„Çí @ai-sdk/google „Å´‰øÆÊ≠£ÔºÅ‚òÖ‚òÖ‚òÖ

      - name: Restore research
        env:
          RESEARCH_B64: ${{ needs.research.outputs.research_b64 }}
        run: |
          mkdir -p .note-artifacts
          echo "$RESEARCH_B64" | base64 -d > .note-artifacts/research.md || echo "$RESEARCH_B64" | base64 --decode > .note-artifacts/research.md

      - name: Generate draft (title/body/tags)
        run: |
          cat > write.mjs <<'EOF'
          import { generateText } from 'ai';
          import { google } from '@ai-sdk/google'; // ‚òÖ‚òÖ‚òÖ„Åì„Åì„Çí @ai-sdk/google „Å´‰øÆÊ≠£ÔºÅ‚òÖ‚òÖ‚òÖ
          import fs from 'fs';
          const theme=process.env.THEME||''; const target=process.env.TARGET||''; const message=process.env.MESSAGE||''; const cta=process.env.CTA||'';
          const inputTags=(process.env.INPUT_TAGS||'').split(',').map(s=>s.trim()).filter(Boolean);
          const researchReport=fs.readFileSync('.note-artifacts/research.md','utf8');
          const modelName = 'gemini-2.0-flash-lite';
          function extractJsonFlexible(raw){const t=(raw||'').trim().replace(/\u200B/g,'');try{return JSON.parse(t);}catch{}const m=t.match(/```[a-zA-Z]*\s*([\s\S]*?)\s*```/);if(m&&m[1]){try{return JSON.parse(m[1].trim());}catch{}}const f=t.indexOf('{'),l=t.lastIndexOf('}');if(f!==-1&&l!==-1&&l>f){const c=t.slice(f,l+1);try{return JSON.parse(c);}catch{}}return null;}
          
          async function repairJson(raw){
            const sys='„ÅÇ„Å™„Åü„ÅØJSONÊï¥ÂΩ¢„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åß„Åô„ÄÇÂÖ•Âäõ„Åï„Çå„Åü„ÉÜ„Ç≠„Çπ„Éà„Åã„Çâ„ÄÅ{"title":string,"draftBody":string,"tags":string[]} „ÅÆÂΩ¢Âºè„ÅßJSON„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíÊäΩÂá∫„Åæ„Åü„ÅØÁîüÊàê„Åó„ÄÅJSONÊñáÂ≠óÂàó„ÅÆ„Åø„ÇíËøî„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇJSON‰ª•Â§ñ„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÅØ‰∏ÄÂàáÂê´„ÇÅ„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ';
            const {text}=await generateText({
              model: google(modelName), // ‚òÖ‚òÖ‚òÖ„Åì„Åì„Çí google() „Å´‰øÆÊ≠£ÔºÅ‚òÖ‚òÖ‚òÖ
              system:sys,
              prompt:String(raw),
              temperature:0,
              maxTokens:8000,
              // responseFormat: { type: 'json' }, // ‚òÖGemini Pro„ÅØJSON„É¢„Éº„Éâ„Çí„Çµ„Éù„Éº„Éà„Åó„Å¶„Å™„ÅÑ„Åì„Å®„Åå„ÅÇ„Çã„ÅÆ„Åß„ÄÅ„ÅÑ„Å£„Åü„Çì„Ç≥„É°„É≥„Éà„Ç¢„Ç¶„Éà
            });
            return extractJsonFlexible(text||'');
          }
          
          function sanitizeTitle(t){
            let s=String(t||'').trim();
            s=s.replace(/^```[a-zA-Z0-9_-]*\s*$/,'').replace(/^```$/,'');
            s=s.replace(/^#+\s*/,'');
            s=s.replace(/^"+|"+$/g,'').replace(/^'+|'+$/g,'');
            s=s.replace(/^`+|`+$/g,'');
            s=s.replace(/^json$/i,'').trim();
            if(!s) s='„Çø„Ç§„Éà„É´ÔºàËá™ÂãïÁîüÊàêÔºâ';
            return s;
          }
          function deriveTitleFromText(text){
            const lines=(text||'').split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
            const firstReal=lines.find(l=>!/^```/.test(l))||lines[0]||'';
            return sanitizeTitle(firstReal);
          }
          
          const sysWrite = [
                '„ÅÇ„Å™„Åü„ÅØÂ∏∏„Å´„Äå„Éû„É°„Äç„Å®„ÅÑ„ÅÜ‰∏Ä‰∫∫Áß∞„ÅÆÊó•Êú¨‰∫∫Â•≥ÊÄß„ÇØ„É™„Ç®„Ç§„Çø„Éº„Å®„Åó„Å¶ÊñáÁ´†„ÇíÊõ∏„Åç„Åæ„Åô„ÄÇ',
                'Êõ∏„ÅçÊâã„ÅØ„Éû„É°„ÄÅË™≠ËÄÖ„ÅØÂà•„ÄÇË™≠ËÄÖ„ÅåË™∞„Åß„ÇÇ„ÄÅË™û„ÇäÊâã„ÅØ„Éû„É°„ÅßÂõ∫ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
                'Âè£Ë™ø„ÅØ„ÇÑ„Çè„Çâ„Åã„Åè„ÄÅ‰ºöË©±7 : Ëß£Ë™¨3„ÅßÊõ∏„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
                'Â∞ÇÈñÄÁî®Ë™û„ÇíÂá∫„Åó„Åü„Çâ„Åô„Åê„Å´„Äå„Å§„Åæ„Çä„Äú„Äç„ÅßË®Ä„ÅÑÊèõ„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
                '1ÊÆµËêΩ„ÅØ3„Äú5Ë°å‰ª•ÂÜÖ„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
                'ÊßãÊàê„ÅØ„ÄåÂ∞éÂÖ• ‚Üí ËÉåÊôØ„ÉªÁêÜÁî± ‚Üí ÊâãÈ†Ü„Éª„ÇÑ„ÇäÊñπ ‚Üí „Åæ„Å®„ÇÅ„ÉªCTA„Äç„ÅßÂÖÖÂàÜ„Åß„Åô„ÄÇ',
                'Êú¨Êñá„Åß„ÅØÁµµÊñáÂ≠ó„ÅØ‰Ωø„Å£„Å¶„ÇÇ1ÊÆµËêΩ„Å´1ÂÄã„Åæ„Åß„ÄÇ',
                'Ë®ò‰∫ã„ÅÆ„ÅÑ„Å°„Å∞„ÇìÊúÄÂæå„ÅÆÊñá„Å´„ÅØ„Ç™„ÉÅ„Å®„Åó„Å¶ÁµµÊñáÂ≠ó„Çí1ÂÄã„Å†„Åë‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑÔºà‰æãÔºöüôÑ „ÇÑ ü•∫ „ÇÑ üòäÔºâ„ÄÇ',
                'ÂÖ®‰Ωì„ÅÆÈï∑„Åï„ÅØ3000„Äú4500ÊñáÂ≠ó„ÇíÁõÆÂÆâ„Å´„ÄÇ5000ÊñáÂ≠ó„ÇíË∂Ö„Åà„Å™„ÅÑ„Åì„Å®„ÄÇ',
                'ÂøÖ„Åö {"title":"‚Ä¶","draftBody":"‚Ä¶","tags":[‚Ä¶]} „ÅÆJSON„Å†„Åë„ÇíËøî„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ‰ªñ„ÅÆÊñáÁ´†„ÅØÊõ∏„Åã„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ',
                '„Äå‰∏ãÂ±±„Åï„Çì„Äç„ÇÑ‰ªñ„Ç≠„É£„É©„ÅÆÂè£Ë™ø„ÉªÊ±∫„ÇÅ„Çº„É™„Éï„ÅØ‰Ωø„Çè„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ'
                 ].join('\n');

          const prompt=[
            "‰ª•‰∏ã„ÅÆË¶Å‰ª∂„Å®„É™„Çµ„Éº„ÉÅÂÜÖÂÆπ„Å´Âü∫„Å•„Åç„ÄÅnote.comÁî®„ÅÆË®ò‰∫ã„ÇíJSONÂΩ¢Âºè„ÅßÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
            `{„ÉÜ„Éº„Éû}: ${theme}`,
            `{„Éö„É´„ÇΩ„ÉäÔºàË™≠ËÄÖÔºâ}: ${target}`,
            `{„É™„Çµ„Éº„ÉÅÂÜÖÂÆπ}: ${researchReport}`,
            `{Ë®ò‰∫ã„Åß‰ºù„Åà„Åü„ÅÑÊ†∏„É°„ÉÉ„Çª„Éº„Ç∏}: ${message}`,
            `{Ë™≠Âæå„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥(CTA)}: ${cta}`
          ].join('\n');
          
          const {text}=await generateText({
            model: google(modelName), // ‚òÖ‚òÖ‚òÖ„Åì„Åì„Çí google() „Å´‰øÆÊ≠£ÔºÅ‚òÖ‚òÖ‚òÖ
            system:sysWrite,
            prompt,
            temperature: 0.65,
            maxTokens: 12000,
            // responseFormat: { type: 'json' }, // ‚òÖGemini Pro„ÅØJSON„É¢„Éº„Éâ„Çí„Çµ„Éù„Éº„Éà„Åó„Å¶„Å™„ÅÑ„Åì„Å®„Åå„ÅÇ„Çã„ÅÆ„Åß„ÄÅ„ÅÑ„Å£„Åü„Çì„Ç≥„É°„É≥„Éà„Ç¢„Ç¶„Éà
          });
          
          let obj=extractJsonFlexible(text||'')||await repairJson(text||'');
          let title, draftBody, tags; if(obj){title=sanitizeTitle(obj.title); draftBody=String(obj.draftBody||'').trim(); tags=Array.isArray(obj.tags)?obj.tags.map(String):[]}
          if(!title||!draftBody){ title=deriveTitleFromText(text||''); const lines=(text||'').split(/\r?\n/); draftBody=lines.slice(1).join('\n').trim()||(text||''); tags=[]}
          if(inputTags.length){tags=Array.from(new Set([...(tags||[]),...inputTags]));}
          fs.writeFileSync('.note-artifacts/draft.json',JSON.stringify({title,draftBody,tags},null,2));
          EOF
          node write.mjs

      - name: Collect draft
        id: collect
        run: |
          title=$(node -e "console.log(JSON.parse(require('fs').readFileSync('.note-artifacts/draft.json','utf8')).title)")
          b64=$(base64 -w 0 .note-artifacts/draft.json 2>/dev/null || base64 .note-artifacts/draft.json)
          echo "title<<EOF" >> $GITHUB_OUTPUT
          echo "$title" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "draft_json_b64<<EOF" >> $GITHUB_OUTPUT
          echo "$b64" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload draft artifact
        uses: actions/upload-artifact@v4
        with:
          name: draft-artifact
          path: .note-artifacts/draft.json

  factcheck:
    name: Fact-check (Gemini + Tavily)
    needs: write
    runs-on: ubuntu-latest
    env:
      GOOGLE_GENERATIVE_AI_API_KEY: ${{ secrets.GOOGLE_GENERATIVE_AI_API_KEY }}
      TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
      TITLE: ${{ needs.write.outputs.title }}
    outputs:
      title: ${{ steps.collect.outputs.title }}
      final_b64: ${{ steps.collect.outputs.final_b64 }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install AI SDK
        run: |
          npm init -y
          npm i ai @ai-sdk/google # ‚òÖ‚òÖ‚òÖ„Åì„Åì„Çí @ai-sdk/google „Å´‰øÆÊ≠£ÔºÅ‚òÖ‚òÖ‚òÖ

      - name: Restore draft json
        env:
          DRAFT_JSON_B64: ${{ needs.write.outputs.draft_json_b64 }}
        run: |
          mkdir -p .note-artifacts
          echo "$DRAFT_JSON_B64" | base64 -d > .note-artifacts/draft.json || echo "$DRAFT_JSON_B64" | base64 --decode > .note-artifacts/draft.json

      - name: Fact-check with Tavily
        run: |
          cat > factcheck.mjs <<'EOF'
          import { generateText } from 'ai';
          import { google } from '@ai-sdk/google';
          import fs from 'fs';

          const draft = JSON.parse(fs.readFileSync('.note-artifacts/draft.json', 'utf8'));
          const modelName = 'gemini-2.0-flash-lite';
          const TAVILY_API_KEY = process.env.TAVILY_API_KEY || '';

          // 429„Å®„ÅãAPIËêΩ„Å°„ÅÆ„Å®„Åç„Å´„Åì„Åì„ÇíÂëº„Å∂
          function fallback() {
            // draft.json „Çí„Åù„ÅÆ„Åæ„Åæ final.json „Å´„Åô„Çã„Å†„Åë
            fs.writeFileSync('.note-artifacts/final.json', JSON.stringify({
              title: draft.title,
              body: draft.draftBody,
              tags: Array.isArray(draft.tags) ? draft.tags : [],
            }, null, 2));
            console.log('factcheck: skipped (quota or API error). used draft.json as final.json');
          }

          async function main() {
            // Tavily„Ç≠„Éº„ÅåÁÑ°„ÅÑ„Å®„Åç„ÇÇ„Çπ„Ç≠„ÉÉ„Éó„Åß„ÅÑ„ÅÑ
            if (!TAVILY_API_KEY) {
              console.warn('factcheck: TAVILY_API_KEY not set. skipping and using draft.json');
              return fallback();
            }

            try {
              // ‚ë† „Åæ„Åö„ÉÅ„Çß„ÉÉ„ÇØ„Åô„Çã„Åü„ÇÅ„ÅÆÊ§úÁ¥¢„ÇØ„Ç®„É™„ÇíÂ∞ë„Å™„ÇÅ„Åß‰Ωú„Çâ„Åõ„Çã
              const { text: queriesText } = await generateText({
                model: google(modelName),
                system: '„ÅÇ„Å™„Åü„ÅØË®ò‰∫ã„ÅÆ‰∫ãÂÆüÁ¢∫Ë™ç„ÅÆ„Åü„ÇÅ„ÅÆÊ§úÁ¥¢„ÇØ„Ç®„É™„Å†„Åë„ÇíËøî„Åô„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åß„Åô„ÄÇÊúÄÂ§ß3‰ª∂„Åß„ÄÇ',
                prompt: String(draft.draftBody || '').slice(0, 4000),
                temperature: 0,
                maxTokens: 512,
              });

              let queries = [];
              try {
                queries = JSON.parse(queriesText);
              } catch {
                queries = [];
              }
              if (!Array.isArray(queries) || !queries.length) {
                // „ÅÜ„Åæ„ÅèÂèñ„Çå„Å™„Åã„Å£„Åü„Çâ„Åù„ÅÆ„Åæ„ÅæÈÄö„Åô
                return fallback();
              }

              // ‚ë° Tavily„Çí1„Äú3Âõû„Å†„ÅëÂè©„ÅèÔºàÂ§ö„Åô„Åé„Çã„Å®„Åæ„Åü429„Å´„Å™„ÇãÔºâ
              const evidence = [];
              for (const q of queries.slice(0, 3)) {
                const res = await fetch('https://api.tavily.com/search', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    api_key: TAVILY_API_KEY,
                    query: q,
                    search_depth: 'basic',
                    max_results: 3,
                    include_answer: true,
                  }),
                });
                const json = await res.json().catch(() => ({}));
                evidence.push({ query: q, ...json });
              }

              // ‚ë¢ Gemini„Åß„ÄåË™§„Çä„Åå„ÅÇ„Å£„Åü„ÇâÁõ¥„Åó„Å¶„Äç„Å®Êäï„Åí„Çã
              const { text: fixed } = await generateText({
                model: google(modelName),
                system: '„ÅÇ„Å™„Åü„ÅØË®ò‰∫ã„ÅÆ‰∫ãÂÆüÁ¢∫Ë™ç„ÇíË°å„ÅÑ„ÄÅË™§„Çä„Åå„ÅÇ„Çå„Å∞Áõ¥„Åó„ÅüÊú¨Êñá„Å†„Åë„ÇíËøî„Åó„Åæ„Åô„ÄÇJSON„ÇÑ„Ç≥„Éº„Éâ„Éï„Çß„É≥„Çπ„ÅØÂá∫Âäõ„Åó„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ',
                prompt: [
                  '## ÂÖÉË®ò‰∫ã',
                  draft.draftBody,
                  '',
                  '## ÂèÇËÄÉÊÉÖÂ†±ÔºàTavilyÔºâ',
                  JSON.stringify(evidence, null, 2)
                ].join('\n'),
                temperature: 0.3,
                maxTokens: 6000,
              });

              fs.writeFileSync('.note-artifacts/final.json', JSON.stringify({
                title: draft.title,
                body: fixed.trim() || draft.draftBody,
                tags: Array.isArray(draft.tags) ? draft.tags : [],
              }, null, 2));
            } catch (err) {
              // ‚òÖ„Åì„Åì„Åå„Éù„Ç§„É≥„ÉàÔºö429„ÇíÊè°„Çä„Å§„Å∂„Åó„Å¶ÊàêÂäüÊâ±„ÅÑ„Å´„Åô„Çã
              const msg = String(err?.message || '');
              if (msg.includes('RESOURCE_EXHAUSTED') || msg.includes('429')) {
                console.warn('factcheck: 429 / RESOURCE_EXHAUSTED. fallback to draft.json');
                return fallback();
              }
              console.error('factcheck: unexpected error', err);
              return fallback();
            }
          }

          await main();
          EOF

          node factcheck.mjs


      - name: Upload fact-check artifact
        uses: actions/upload-artifact@v4
        with:
          name: final-artifact
          path: .note-artifacts/final.json

      - name: Collect final
        id: collect
        run: |
          title=$(node -e "console.log(JSON.parse(require('fs').readFileSync('.note-artifacts/final.json','utf8')).title)")
          b64=$(base64 -w 0 .note-artifacts/final.json 2>/dev/null || base64 .note-artifacts/final.json)
          echo "title<<EOF" >> $GITHUB_OUTPUT
          echo "$title" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "final_b64<<EOF" >> $GITHUB_OUTPUT
          echo "$b64" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  post:
    name: Post to note.com (Playwright)
    needs: factcheck
    if: ${{ github.event.inputs.dry_run != 'true' }}
    runs-on: [self-hosted, Windows, X64]
    timeout-minutes: 30
    defaults:
      run:
        shell: powershell
    env:
      IS_PUBLIC: ${{ github.event.inputs.is_public }}
      START_URL: https://editor.note.com/new
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Show outbound IP
        run: '(Invoke-RestMethod https://api.ipify.org).ToString() | Write-Output'

      - name: Install Playwright
        run: |
          npm init -y
          npm i playwright marked
          npx playwright install chromium

      - name: Prepare storageState (decode from NOTE_STATE_B64)
        id: state
        env:
          STATE_B64: ${{ secrets.NOTE_STATE_B64 }}
        run: |
          if (-not $env:STATE_B64) { Write-Error "NOTE_STATE_B64 secret is not set"; exit 1 }
          $path = Join-Path $env:RUNNER_TEMP "note-state.json"

          # Base64 ‚Üí „Éê„Ç§„ÉàÂàó ‚Üí „Éï„Ç°„Ç§„É´
          [IO.File]::WriteAllBytes($path, [Convert]::FromBase64String($env:STATE_B64))

          # ‚úÖ JSON„Å®„Åó„Å¶Ê≠£„Åó„ÅÑ„ÅãÊ§úÊüªÔºàÂ£ä„Çå„Å¶„Åü„Çâ„Åì„Åì„ÅßÊ≠¢„Åæ„ÇãÔºâ
          Get-Content $path -Raw | ConvertFrom-Json | Out-Null

          # Ê¨°„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„Å´„ÄåÁΩÆ„ÅçÂ†¥ÊâÄ„Äç„ÇíÊïô„Åà„Çã
          "STATE_PATH=$path" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Download final artifact
        uses: actions/download-artifact@v4
        with:
          name: final-artifact
          path: .note-artifacts

      - name: Restore final
        id: draft
        run: |
          $json = Get-Content ".note-artifacts/final.json" -Raw -Encoding UTF8
          $obj  = $json | ConvertFrom-Json
          $title = $obj.title
          $tags  = ($obj.tags | ForEach-Object { $_.ToString() }) -join ", "
          "TITLE=$title" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "TAGS=$tags"   | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
      - name: Publish via Playwright (draft or public)
        id: publish
        env:
          STATE_PATH: ${{ steps.state.outputs.STATE_PATH }}  # ‚Üê „Åì„ÇåÔºÅ
          TITLE: ${{ steps.draft.outputs.TITLE }}
          TAGS:  ${{ steps.draft.outputs.TAGS }}
          START_URL: ${{ env.START_URL }}
          IS_PUBLIC: ${{ env.IS_PUBLIC }}
        run: |
          Copy-Item ".note-artifacts/final.json" "final.json" -Force
          node post.mjs | Tee-Object -FilePath post.log

      - name: Upload debug artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: note-debug-artifacts
          path: |
            network.har
            trace.zip
            post.log
            **/*.png                
